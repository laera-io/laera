# Contributing

* [Development](#development)
  * [Flutter](#flutter)
  * [Non-Flutter dependencies](#non-flutter-dependencies)
  * [Test and lint](#test-and-lint)
  * [Autogenerated code](#autogenerated-code)
  * [Build app icons](#build-app-icons)
  * [Build apk](#build-apk)
  * [Upgrade Flutter version](#upgrade-flutter-version)
* [Releasing](#releasing)
  * [Automatically](#automatically)
  * [Manually](#manually)
* [Signing](#signing)
  * [Generate new `.jks` file](#generate-new-jks-file)
  * [`keystore.properties` file](#keystoreproperties-file)
  * [Generate `.pem` certificate](#generate-pem-certificate)
  * [Generate data for CI/CD](#generate-data-for-cicd)

## Development

### Flutter

Nothing special, start from [the official page][flutter_home] if you're newbie.

### Non-Flutter dependencies

* Install Java 11 JDK dev package into your OS (for example `dnf install java-11-openjdk-devel` in Fedora);
* Set `JAVA_HOME` environment variable to those SDK (for example `/usr/lib/jvm/java-11` in Fedora);
* Install `ruby 2` dev package and `gem` into your OS (for example `dnf install ruby-devel rubygems` in Fedora);
* Install gem file dependencies by calling `make deps-ruby` in the project root directory;
* Install `make` into your OS;
* Dart and Flutter analytics may be optionally disabled by calling `make disable-analytics`.

### Test and lint

Before every `git commit` and `git push` especially run:

```sh
make
```

### Autogenerated code

> All files ended with `.g.dart` are autogenerated.

To regenerate all `.g.dart` files:

```sh
make generate
```

### Build app icons

Change `assets/icon/logo.png` and then:

```sh
make icon
```

### Build apk

```sh
make build-apk-dev
```

The result will be at `build/app/outputs/flutter-apk/app-debug.apk`.

### Upgrade Flutter version

* Update Flutter and Dart SDK versions at `pubspec.yaml`;
* Update dependencies `flutter pub upgrade`;
* Update Flutter version in all CI/CD pipelines at `.github/workflows/`, env variable `FLUTTER_VERSION`.

## Releasing

### Automatically

* Update app version at `pubspec.yaml`;
* Add changelog to `android/fastlane/metadata/android/en-US/changelogs/`, name of the file is a commits number of `stable` branch (including commit in which the changelog will be added);
* Update some `.txt` files if needed at `android/fastlane/metadata/android/en-US/`;
* Update screenshots and other graphic at `android/fastlane/metadata/android/en-US/images/`;
* Commit all the changes;
* Create GitHub release with `v` prefix. For example `v1.2.3`.

### Manually

* Install extra dependencies
  * `mkdir -p android/fastlane/keys`
  * Put there some files:
    * `google_play_api_key.json` - [api key from `https://play.google.com/console/u/<user_id>/developers/<dev_id>/api-access`][google_play_api_key_docs]
    * `keystore.jks` - [signing key](#generate-jks-file)
    * `keystore.properties` - [properties for `keystore.jks`](#keystoreproperties-file)
* Build `make build-aab`
* Upload to Google Play Console

## Signing

* Signing key must be registered into Google Play Console before using;
* Signing key must be a 2048 bit RSA key and have 25-year validity.

### Generate new `.jks` file

```sh
keytool -genkeypair -alias <alias_name> -keyalg RSA -keysize 2048 -validity 9125 -keystore keystore.jks
```

### `keystore.properties` file

```txt
storeFile=../fastlane/keys/keystore.jks
storePassword=<jks_password>
keyAlias=<alias_name>
keyPassword=<jks_password>
```

### Generate `.pem` certificate

```sh
keytool -export -rfc -alias <alias_name> -file upload_certificate.pem -keystore keystore.jks
```

### Generate data for CI/CD

```sh
base64 -w 0 <file_name>
```

[flutter_home]: https://flutter.dev/
[google_play_api_key_docs]: https://developers.google.com/android-publisher/getting_started
