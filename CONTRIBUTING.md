# Contributing

* [Development](#development)
  * [Flutter](#flutter)
  * [Android dependencies](#android-dependencies)
  * [Other dependencies](#other-dependencies)
  * [Test and lint](#test-and-lint)
  * [Autogenerated code](#autogenerated-code)
  * [Build app icons](#build-app-icons)
  * [Build apk](#build-apk)
  * [Upgrade Flutter version](#upgrade-flutter-version)
* [Releasing](#releasing)
  * [Automatically](#automatically)
  * [Manually](#manually)
* [Signing](#signing)
  * [Generate new `.jks` file](#generate-new-jks-file)
  * [`keystore.properties` file](#keystoreproperties-file)
  * [Generate `.pem` certificate](#generate-pem-certificate)
  * [Generate data for CI/CD](#generate-data-for-cicd)

## Development

### Flutter

* Install `flutter` from [the official install page][flutter_installation].

### Android dependencies

* Install Java 11 JDK dev package (for example `dnf install java-11-openjdk-devel` in Fedora 36);
* Set `JAVA_HOME` environment variable to those SDK (for example `/usr/lib/jvm/java-11` in Fedora 36);
* Install Android SDK via `sdkmanager` (or entire Android Studio if you need it):
  * Download `commandlinetools-<platform>-<build>_latest.zip` file from [Android Studio download page][android_studio_download];
  * Unzip it and place content of the `cmdline-tools` (`bin` and `lib`) like `<your_path>/cmdline-tools/tools/bin` and `<your_path>/cmdline-tools/tools/lib` (for example `$HOME/android/cmdline-tools/tools`);
  * Add path to the `bin` directory to the `PATH` variable (for example add line `export PATH="$HOME/android/cmdline-tools/tools/bin:$PATH"` to the `.zshrc` file);
  * Add path to the Android platform tools that will be installed later (for example add line `export PATH="$HOME/android/platform-tools:$PATH"` to the `.zshrc` file);
  * Set variable `ANDROID_HOME` (for example add line `export ANDROID_HOME="$HOME/android"` to the `~/.zshrc` file);
  * Add plugdev group to your use to be able to run on the devices:
    * Create plugdev group by running `groupadd plugdev`;
    * Add your user to this group by running `usermod -aG plugdev $LOGNAME`;
    * Log out and log in back;
  * Run `sdkmanager "platform-tools" "platforms;android-31" "build-tools;31.0.0" "system-images;android-31;default;x86_64"` and accept all licenses;
  * Accept remaining licenses by running `flutter doctor --android-licenses`;
  * Make sure `flutter doctor` command output has no red sections.

### Other dependencies

* Install `ruby 2` dev package and `gem` (for example `dnf install ruby-devel rubygems` in Fedora 36);
* Install `g++` needed by some ruby dependencies (for example `dnf install gcc-c++` in Fedora 36);
* Install `make` utility;
* Install gem file dependencies by calling `make deps-ruby` in the project root directory;
* Dart and Flutter analytics may be optionally disabled by calling `make disable-analytics`;
* Make sure the installation is complete by running `make` command.

### Test and lint

Before every `git commit` and `git push` especially run:

```sh
make
```

### Autogenerated code

> All files ended with `.g.dart` are autogenerated.

To regenerate all `.g.dart` files:

```sh
make generate
```

### Build app icons

Change `assets/icon/logo.png` and then:

```sh
make icon
```

### Build apk

```sh
make build-apk-dev
```

The result will be at `build/app/outputs/flutter-apk/app-debug.apk`.

### Upgrade Flutter version

* Update Flutter and Dart SDK versions at `pubspec.yaml`;
* Update dependencies `flutter pub upgrade`;
* Update Flutter version in all CI/CD pipelines at `.github/workflows/`, env variable `FLUTTER_VERSION`.

## Releasing

### Automatically

* Update app version at `pubspec.yaml`;
* Add changelog to `android/fastlane/metadata/android/en-US/changelogs/`, name of the file is a commits number of `stable` branch (including commit in which the changelog will be added);
* Update some `.txt` files if needed at `android/fastlane/metadata/android/en-US/`;
* Update screenshots and other graphic at `android/fastlane/metadata/android/en-US/images/`;
* Commit all the changes;
* Create GitHub release with `v` prefix (for example `v1.2.3`).

### Manually

* Install extra dependencies
  * `mkdir -p android/fastlane/keys`
  * Put there some files:
    * `google_play_api_key.json` - [api key from `https://play.google.com/console/u/<user_id>/developers/<dev_id>/api-access`][google_play_api_key_docs]
    * `keystore.jks` - [signing key](#generate-jks-file)
    * `keystore.properties` - [properties for `keystore.jks`](#keystoreproperties-file)
* Build `make build-aab`
* Upload to Google Play Console

## Signing

* Signing key must be registered into Google Play Console before using;
* Signing key must be a 2048 bit RSA key and have 25-year validity.

### Generate new `.jks` file

```sh
keytool -genkeypair -alias <alias_name> -keyalg RSA -keysize 2048 -validity 9125 -keystore keystore.jks
```

### `keystore.properties` file

```txt
storeFile=../fastlane/keys/keystore.jks
storePassword=<jks_password>
keyAlias=<alias_name>
keyPassword=<jks_password>
```

### Generate `.pem` certificate

```sh
keytool -export -rfc -alias <alias_name> -file upload_certificate.pem -keystore keystore.jks
```

### Generate data for CI/CD

```sh
base64 -w 0 <file_name>
```

[flutter_installation]: https://docs.flutter.dev/get-started/install
[google_play_api_key_docs]: https://developers.google.com/android-publisher/getting_started
[android_studio_download]: https://developer.android.com/studio
